#!/usr/bin/env mantidpython

import LokiMantid.mantidApi as api
# from Core import FindData
from LokiMantid.monitorSpectrum import createFloodSourceTofSpectrum, extractMcStasMonitorData

import numpy as np
from pathlib import Path

from glob import glob
import math as m
import os
import argparse
import sys

parser = argparse.ArgumentParser(description = 'Process detection MCPL files from loki simulations to produce nexus files (one for the detectors, one for the monitors) readable with Mantid.')
parser.add_argument('filename', help = 'Input detection MCPL file. Assumed to be a path relative to the directory defined by the G4PROC_MCPL_BASEDIR_LOKI environment variable, unless a full path is given.')
parser.add_argument('-s','--savename', help = 'Output nexus filename base. Automatically extended by "_detector.nxs" and "_monitor.nxs". Assumed to be a path relative to the directory defined by the G4PROC_SAVEDIR_LOKI environment variable, unless a full path is given.')

parser.add_argument('--rear_detector_distance_m', help = 'Rear detector distance.')
parser.add_argument('--analysis_straw_pixel_number', help = 'Number of pixels per detector straw.')
parser.add_argument('--detectorWorkspaceTofStart', default = 11000, type=int, help = 'TOF start for the detector workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('--detectorWorkspaceTofBinWidth', default = 1000, type=int, help = 'TOF bin width for the detector workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('--detectorWorkspaceTofEnd', default = 113000, type=int, help = 'TOF end for the detector workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('--monitorWorkspaceTofStart', default = 9000, type=int, help = 'TOF start for the monitor workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('--monitorWorkspaceTofBinWidth', default = 1000, type=int, help = 'TOF bin width for the monitor workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('--monitorWorkspaceTofEnd', default = 100000, type=int, help = 'TOF end for the monitor workspace spectra binning. (default: %(default)d microSeconds)')
parser.add_argument('-det', '--detectorOnly', action = 'store_true', help = 'Create only the detector spectrum file.')
parser.add_argument('-mon', '--monitorOnly', action = 'store_true', help = 'Create only the monitor spectrum file.')
parser.add_argument('-no', '--noOutput', action = 'store_true', help = 'Developer option. No output is generated.')
parser.add_argument('-v', '--verbose', action = 'store_true', help = 'Enable more verbosity.')
parser.add_argument('-show', '--showMetadata', action = 'store_true', help = 'Only output metadata stored in the detection MCPL file (without producing nxs files).')
parser.add_argument('-i', '--idfCreation', action = 'store_true', help = 'Save the idf files created based on inputs.')
parser.add_argument('--singleNexus', action = 'store_true', default=True, help = 'Save a single nexus file (or idf) for all detector banks together, instead of one for each.')

mcstasParamGroup = parser.add_argument_group('McStas parameters', 'Supplement McStas simulation parameters')
mcstasParamGroup.add_argument('--mcstasDir', help = 'Name of the McStas directory containing the monitor spectra.  Assumed to be a path relative to the directory defined by the G4PROC_MCSTAS_BASEDIR_LOKI environment variable, unless a full path is given.')
mcstasParamGroup.add_argument('--mcstas_monitors', nargs='*', help = 'Name of the McStas monitor files (this option overrides the default ones).')

floodPramGroup = parser.add_argument_group('Flood source parameters', 'Supplement flood source simulation parameters missing from the detection MCPL files (legacy files), or override parameters stored in the files.')
floodPramGroup.add_argument('-n', '--neutronNumber', type=float, help = 'The total number of neutrons used to create the (probably merged) detection MCPL input file.')
floodPramGroup.add_argument('--neutron_wavelength_min_aangstrom', help = 'Minimum neutron wavelength used for the flood source sampling.')
floodPramGroup.add_argument('--neutron_wavelength_max_aangstrom', help = 'Maximum neutron wavelength used for the flood source sampling.')
floodPramGroup.add_argument('--sampling_cone_opening_deg', help = 'Maximum opening angle of the cone used for the direction sampling.')
floodPramGroup.add_argument('--sampling_cone_opening_min_deg', help = 'Minimum opening angle of the cone used for the direction sampling.')
floodPramGroup.add_argument('--source_monitor_distance_meters', help = 'Source to preSample monitor distance. The preSample monitor TOF spectrum is generated for this distance.')
floodPramGroup.add_argument('--aiming_bank_id', help = 'Id(s) of the banks to include.')
floodPramGroup.add_argument('--nominal_source_sample_distance_meters', help = 'Nominal source(moderator) to sample position distance. [m]')

args = parser.parse_args()

isFloodSourceSimulation = False
if not args.savename and not (args.noOutput or args.showMetadata):
  parser.error("Save filename (-s, --savename) is required, unless no output (-no, --noOutput) or metadata (-show, --showMetadata) option is selected")
if not args.showMetadata and (not args.neutronNumber and args.mcstasDir is None):
  parser.error("Either --neutronNumber (for Flood source simulation) or --mcstasDir (for McStas+Geant4 simulation) is required, unless the --showMetadata option is used to examine the metadata stored in the detection MCPL file!")
if args.neutronNumber:
  if args.mcstasDir:
    parser.error("Both --neutronNumber (for Flood source simulation) and --mcstasDir (for McStas+Geant4 simulation) options cannot be provided!")
  if not args.neutronNumber.is_integer():
   parser.error(" --neutronNumber has to be an integer.") #float input type is only allowed to handle '1e9' format
  else:
    simulatedNeutronNumber = int(args.neutronNumber)
    isFloodSourceSimulation = True

def resolveFilename(filename, baseEnvVar):
  base = os.environ.get(baseEnvVar, None)
  if os.path.isabs(filename):
    return Path(filename)
  elif base:
    return Path(base) / filename
  else:
    sys.exit(f"ERROR: The provided filename ({filename}) is not an absolute path, and the {baseEnvVar} env var is not set.")

mcplFile = resolveFilename(args.filename, 'G4PROC_MCPL_BASEDIR_LOKI')
if not (args.noOutput or args.showMetadata):
  saveFileBase = resolveFilename(args.savename, 'G4PROC_SAVEDIR_LOKI')
if args.mcstasDir:
  mcStasFolder = resolveFilename(args.mcstasDir, 'G4PROC_MCSTAS_BASEDIR_LOKI')
#TODO check if files exists and stop with error, or overide?

lokiDefaultParams = {'rear_detector_distance_m':5,
                     'neutron_wavelength_min_aangstrom': 2,
                     'neutron_wavelength_max_aangstrom': 13,
                     'sampling_cone_opening_deg': 49.6,
                     'sampling_cone_opening_min_deg': 0,
                     'source_monitor_distance_meters': 23.599,
                     'nominal_source_sample_distance_meters': 23.6,
                     'analysis_straw_pixel_number': 512,
                     'mcstas_monitors': ['Mon10_PostFOC_*.t', 'PreSampleMonitor_*.t', 'PostSampleMonitor_*.t', '-'],
                     'aiming_bank_id': '876543210'}
from LokiMantid.paramHandler import ParamHandler
params = ParamHandler(mcplFile, vars(args), lokiDefaultParams, args.verbose)

if not args.mcstas_monitors: #TODO test
#TODO maybe implement a set option, to indicate that parameters can change! (then it would make sense to prepend with '_')
  params.params['mcstas_monitors'][3] = f"beamstopMonitor_{params.get('rear_detector_distance_m')}m_*.t"
params.params['aiming_bank_id'] = list(str(params.get('aiming_bank_id')))

if args.showMetadata:
  params.dumpMCPLParams()
  params.dumpParams()
  sys.exit()

from LokiMantid.workspaceCreator import workspaceCreator
workspaces = workspaceCreator(params, args.singleNexus, args.idfCreation)
instrumentDefinitionFile_monitor = workspaces.getMonitorIDF()
if args.idfCreation:
  if not args.noOutput:
    workspaces.saveIdfFiles(f'{saveFileBase.parents[0]}/LOKI_Definition')
  else:
    workspaces.saveIdfFiles('_', printOnly=True)
  print("It's okey until here")
  sys.exit()
#TODO old tube numbering is not supported

# parameters used for the TOF spectra binning for both the monitors and detectors
wsBinParams_monitor = [args.monitorWorkspaceTofStart, args.monitorWorkspaceTofBinWidth, args.monitorWorkspaceTofEnd]
wsBinParams_detector = [args.detectorWorkspaceTofStart, args.detectorWorkspaceTofBinWidth, args.detectorWorkspaceTofEnd]

if not args.detectorOnly:
  monitorTOF = []
  monitorIntensity = []
  monitorError = []
  if isFloodSourceSimulation:
    directionBiasMultiplicationFactor = 2/(m.cos(params.get('sampling_cone_opening_min_deg')*m.pi/180) - m.cos(params.get('sampling_cone_opening_deg')*m.pi/180))
    incidentNeutronNumber = simulatedNeutronNumber * directionBiasMultiplicationFactor
    if args.verbose:
       print("     Handling flood source neutron number:")
       print(f"        Number of simulated neutrons: {simulatedNeutronNumber}")
       print(f"        Multiplication factor due to biassed direction sampling: {directionBiasMultiplicationFactor}")
       print(f"        Resulting incident neutron number on the monitor: {incidentNeutronNumber}")

    floodTof, floodIntensity, floodError = createFloodSourceTofSpectrum(incidentNeutronNumber, params.get('neutron_wavelength_min_aangstrom'), params.get ('neutron_wavelength_max_aangstrom'), params.get('source_monitor_distance_meters'), verbose=args.verbose)

    #PreSample monitor is expected to be the 3rd spectrum out of 4, so empty spectra are added here
    blank = np.zeros_like(floodTof)
    monitorTOF = [floodTof, floodTof, floodTof, floodTof]
    monitorIntensity = [blank, blank, floodIntensity, blank]
    monitorError = [blank, blank, floodError, blank]
  else: #McStas+Geant4 simulation
    for i, filename in enumerate(params.get('mcstas_monitors')):
      if len(glob(str(mcStasFolder / filename))) == 1:
        monitorFilePath = glob(str(mcStasFolder / filename))[0]
      else:
        sys.exit(f'Problem with finding {mcStasFolder}/{filename}')

      tof, wavelength, y, e = extractMcStasMonitorData(monitorFilePath, args.verbose)
      monitorTOF.append(wavelength if tof is None else tof)
      monitorIntensity.append(y)
      monitorError.append(e)

  mcStasMonitorWS = api.createMonitorWorkspace(monitorTOF, monitorIntensity, monitorError, instrumentDefinitionFile_monitor)
  mcStasMonitorWS_rebin = api.rebinMonitorWorkspace(mcStasMonitorWS, wsBinParams_monitor, 'mcStasMonitorWS_rebin')
  api.addProperties(mcStasMonitorWS_rebin, params)
  if not args.noOutput:
    saveFilename = str(saveFileBase) + "_monitor.nxs"
    api.saveNexus(mcStasMonitorWS_rebin, saveFilename)

if not args.monitorOnly:
  idConverter = lambda id: 1 + id #detector IDs in the IDF (and ICD) file starts from 1 (as opposed to the zero-based numbering in the Geant4 geometry)
  api.addMcplDetectionEventsToWorkspaces(workspaces, params.getMcplFile(), idConverter=idConverter, verbose=args.verbose)
  #TODO add some kind of verification or statistics
  # - number of events in the MCPL file
  # - number of detection events 

  for id, ws in workspaces.detectors.items():
    Geant4DataWS_rebin = api.rebinDetectorWorkspace(ws, wsBinParams_detector, f'Geant4DataWS2D_bank{id}_rebin')
    api.addProperties(Geant4DataWS_rebin, params)
    Geant4DataWS_rebin.setYUnitLabel("Counts")
    Geant4DataWS_rebin.getAxis(0).setUnit("TOF")
    if not args.noOutput:
      aimingBankIds = ''.join(params.params['aiming_bank_id'])
      aimingBankIdsText = f"_banks{aimingBankIds}" if aimingBankIds != lokiDefaultParams['aiming_bank_id'] else ''
      bankText = f"_bank{id}" if not args.singleNexus else aimingBankIdsText
      saveFilename = str(saveFileBase) + f"{bankText}_detector.nxs"
      api.saveNexus(Geant4DataWS_rebin, saveFilename)
